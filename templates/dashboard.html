{% extends "base.html" %}
{% block content %}
<div class="flex flex-col lg:flex-row gap-8">
    <!-- Left Sidebar: Search & Profiles -->
    <div class="w-full lg:w-1/3 p-6 bg-white rounded-xl shadow-md space-y-8">
        <!-- Search & Scrape Section -->
        <div>
            <h2 class="text-2xl font-bold mb-4 text-gray-800">New Job Search</h2>
            <form id="search-form" class="space-y-4">
                <div class="relative">
                    <label for="search_terms" class="block text-sm font-medium text-gray-700">Keywords (e.g., Python, AI, Data Science)</label>
                    <input type="text" name="search_terms" id="search_terms" placeholder="Keywords" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="location" class="block text-sm font-medium text-gray-700">Location (e.g., Bengaluru)</label>
                        <input type="text" name="location" id="location" placeholder="City or 'Remote'"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="experience" class="block text-sm font-medium text-gray-700">Experience (e.g., 2-5 years)</label>
                        <input type="text" name="experience" id="experience" placeholder="e.g. '3 years', 'Senior', 'Entry Level'"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                </div>
                <div>
                    <label for="job_type" class="block text-sm font-medium text-gray-700">Job Type</label>
                    <select id="job_type" name="job_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="">Any</option>
                        <option value="Full-time">Full-time</option>
                        <option value="Part-time">Part-time</option>
                        <option value="Contract">Contract</option>
                        <option value="Internship">Internship</option>
                    </select>
                </div>
                <div class="flex gap-4">
                    <button type="submit" id="scrape-btn"
                            class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Start Search
                    </button>
                    <button type="button" id="save-profile-btn"
                            class="w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Save Profile
                    </button>
                </div>
            </form>
            <div id="progress-container" class="mt-4 hidden">
                <div class="text-sm font-medium text-gray-700">Progress: <span id="task-status"></span></div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                    <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <!-- Saved Profiles Section -->
        <div id="saved-profiles-container">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Saved Profiles</h2>
            <div class="space-y-4">
                {% if saved_profiles %}
                    {% for profile in saved_profiles %}
                        <div class="bg-gray-50 p-4 rounded-lg flex items-center justify-between shadow-sm">
                            <div>
                                <h3 class="font-semibold text-gray-900">{{ profile.profile_name }}</h3>
                                <p class="text-xs text-gray-500">{{ profile.search_terms }}</p>
                            </div>
                            <div class="flex gap-2">
                                <form action="{{ url_for('apply_profile', profile_id=profile.id) }}" method="POST" class="inline-block apply-profile-form">
                                    <button type="submit" class="text-indigo-600 hover:text-indigo-900 text-sm font-medium">Apply</button>
                                </form>
                                <form action="{{ url_for('delete_profile', profile_id=profile.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this profile?');">
                                    <button type="submit" class="text-red-600 hover:text-red-900 text-sm font-medium">Delete</button>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-sm text-gray-500">No saved profiles. Save a search above!</p>
                {% endif %}
            </div>
        </div>
        
        <!-- User Settings Section -->
        <div>
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Email Settings</h2>
            <form action="{{ url_for('update_settings') }}" method="POST" class="space-y-4">
                <div>
                    <label for="email_recipients" class="block text-sm font-medium text-gray-700">Recipients (comma-separated)</label>
                    <input type="text" name="email_recipients" id="email_recipients"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                           value="{{ user_settings.email_recipients if user_settings else '' }}">
                </div>
                <div>
                    <label for="email_frequency" class="block text-sm font-medium text-gray-700">Frequency</label>
                    <select name="email_frequency" id="email_frequency" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="daily" {% if user_settings and user_settings.email_frequency == 'daily' %}selected{% endif %}>Daily</option>
                        <option value="weekly" {% if user_settings and user_settings.email_frequency == 'weekly' %}selected{% endif %}>Weekly</option>
                        <option value="monthly" {% if user_settings and user_settings.email_frequency == 'monthly' %}selected{% endif %}>Monthly</option>
                    </select>
                </div>
                <div class="flex items-center">
                    <input id="send_excel_attachment" name="send_excel_attachment" type="checkbox"
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                           {% if user_settings and user_settings.send_excel_attachment %}checked{% endif %}>
                    <label for="send_excel_attachment" class="ml-2 block text-sm text-gray-900">Send Excel attachment</label>
                </div>
                <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Save Settings
                </button>
            </form>
        </div>
    </div>

    <!-- Right Content: Job Listings & Filters -->
    <div class="w-full lg:w-2/3 p-6 bg-white rounded-xl shadow-md">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <div class="flex items-center gap-4">
                <h1 class="text-3xl font-bold text-gray-900">Your Jobs ({{ total_jobs }})</h1>
                {% set next_view = 'detailed' if view_mode == 'simple' else 'simple' %}
                {% set query_params = request.args.to_dict() %}
                {% set _ = query_params.update({'view': next_view}) %}
                <a href="{{ url_for('dashboard', **query_params) }}" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
                    Switch to {{ next_view.title() }} View
                </a>
            </div>
            <form action="{{ url_for('delete_all_jobs') }}" method="POST" onsubmit="return confirm('Are you sure you want to delete ALL jobs? This cannot be undone.');">
                <button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-md shadow-sm">Delete All</button>
            </form>
        </div>
        
        <!-- Job Status Chart -->
        <div class="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Application Status Overview</h2>
            <div class="max-w-sm mx-auto">
                <canvas id="jobStatusChart"></canvas>
            </div>
        </div>

        <!-- Filter Form -->
        <form id="filter-form" action="{{ url_for('dashboard') }}" method="GET" class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-4 gap-4">
                <div>
                    <label for="search_query" class="block text-sm font-medium text-gray-700">Search</label>
                    <input type="text" id="search_query" name="search_query" placeholder="Keywords, company..."
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                           value="{{ search_query }}">
                </div>
                <div>
                    <label for="location_filter" class="block text-sm font-medium text-gray-700">Location</label>
                    <input type="text" id="location_filter" name="location_filter" placeholder="City, 'Remote'..."
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                           value="{{ location_filter }}">
                </div>
                <div>
                    <label for="status_filter" class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="status_filter" name="status_filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="all">All Statuses</option>
                        <option value="new" {% if status_filter == 'new' %}selected{% endif %}>New</option>
                        <option value="applied" {% if status_filter == 'applied' %}selected{% endif %}>Applied</option>
                        <option value="interview" {% if status_filter == 'interview' %}selected{% endif %}>Interview</option>
                        <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
                        <option value="offered" {% if status_filter == 'offered' %}selected{% endif %}>Offered</option>
                    </select>
                </div>
                <div>
                    <label for="job_type_filter" class="block text-sm font-medium text-gray-700">Job Type</label>
                    <select id="job_type_filter" name="job_type_filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="all">All Types</option>
                        <option value="Full-time" {% if job_type_filter == 'Full-time' %}selected{% endif %}>Full-time</option>
                        <option value="Part-time" {% if job_type_filter == 'Part-time' %}selected{% endif %}>Part-time</option>
                        <option value="Contract" {% if job_type_filter == 'Contract' %}selected{% endif %}>Contract</option>
                        <option value="Internship" {% if job_type_filter == 'Internship' %}selected{% endif %}>Internship</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Apply Filters</button>
            </div>
        </form>

        <!-- Job Table -->
        <div class="bg-white overflow-hidden sm:rounded-lg">
            <div id="job-list" class="space-y-6">
                {% if jobs %}
                    {% for job in jobs %}
                        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200 hover:shadow-lg transition-shadow duration-300">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="text-lg font-bold text-indigo-600">
                                        {{ job.title }}
                                    </h3>
                                    <p class="text-sm text-gray-600 font-semibold">{{ job.company }}</p>
                                </div>
                                <span class="bg-indigo-100 text-indigo-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">
                                    Score: {{ job.relevance_score | round(2) }}
                                </span>
                            </div>
                            <div class="text-sm text-gray-500 mb-4">
                                <p class="flex items-center gap-1 mb-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    {{ job.location }}
                                </p>
                                {% if view_mode == 'detailed' %}
                                <p class="flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M8 11h.01M12 11h.01M16 11h.01M12 15h.01M16 15h.01M8 15h.01M3 19v-7a2 2 0 012-2h14a2 2 0 012 2v7a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                                    </svg>
                                    Posted: {{ job.posted_date }}
                                </p>
                                <p class="flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                    </svg>
                                    Experience: {{ job.experience }}
                                </p>
                                {% endif %}
                            </div>
                            {% if view_mode == 'detailed' %}
                                <p class="text-gray-700 mb-4 text-sm">{{ job.description | clean_desc | truncate(300, True) }}</p>
                                <div class="flex items-center flex-wrap gap-2 text-xs font-medium text-gray-700 mb-4">
                                    <span class="bg-gray-100 rounded-full px-2 py-1">Source: {{ job.source }}</span>
                                    <span class="bg-gray-100 rounded-full px-2 py-1">Type: {{ job.job_type }}</span>
                                    {% if job.salary and job.salary != 'N/A' %}
                                    <span class="bg-gray-100 rounded-full px-2 py-1">Salary: {{ job.salary }}</span>
                                    {% endif %}
                                    
                                    {% set all_skills = [] %}
                                    {% if job.skills %}{% set _ = all_skills.extend(job.skills.split(',')) %}{% endif %}
                                    {% if job.extracted_tools %}{% set _ = all_skills.extend(job.extracted_tools.split(',')) %}{% endif %}
                                    
                                    {% for skill in all_skills %}
                                        {% if skill.strip() %}
                                        <span class="bg-blue-100 text-blue-800 rounded-full px-2 py-1">{{ skill.strip() }}</span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="flex items-center space-x-4">
                                <a href="{{ job.link }}" target="_blank" class="flex-grow inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                                    Apply Now
                                </a>
                                <button onclick="openApplyModal({{ job.id }}, '{{ job.link }}')" class="flex-grow inline-flex items-center justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                    Assisted Apply
                                </button>
                                <form action="{{ url_for('delete_job', job_id=job.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this job?');" class="hidden sm:inline">
                                    <button type="submit" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                    </button>
                                </form>
                            </div>
                            <div class="mt-4 flex space-x-4 text-xs text-gray-500">
                                {% if job.status == 'new' %}
                                    <span class="bg-blue-100 text-blue-800 font-medium px-2.5 py-0.5 rounded-full">New</span>
                                {% elif job.status == 'applied' %}
                                    <span class="bg-green-100 text-green-800 font-medium px-2.5 py-0.5 rounded-full">Applied</span>
                                {% elif job.status == 'interview' %}
                                    <span class="bg-yellow-100 text-yellow-800 font-medium px-2.5 py-0.5 rounded-full">Interview</span>
                                {% elif job.status == 'rejected' %}
                                    <span class="bg-red-100 text-red-800 font-medium px-2.5 py-0.5 rounded-full">Rejected</span>
                                {% elif job.status == 'offered' %}
                                    <span class="bg-purple-100 text-purple-800 font-medium px-2.5 py-0.5 rounded-full">Offered</span>
                                {% endif %}
                                <button onclick="openStatusModal({{ job.id }}, '{{ job.status }}', '{{ job.notes }}')" class="text-indigo-600 hover:text-indigo-900">Update Status</button>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-10 text-gray-500">
                        <p class="mb-2">No jobs found. Try a new search or adjust your filters!</p>
                        <p>Your last search found 0 jobs.</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- Pagination -->
            <div class="flex justify-center mt-8">
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    {% if current_page > 1 %}
                    <a href="{{ url_for('dashboard', page=current_page-1, sort_by=sort_by, sort_order=sort_order, search_query=search_query, status_filter=status_filter, location_filter=location_filter, job_type_filter=job_type_filter) }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">Previous</a>
                    {% endif %}
                    {% for p in range(1, total_pages + 1) %}
                    <a href="{{ url_for('dashboard', page=p, sort_by=sort_by, sort_order=sort_order, search_query=search_query, status_filter=status_filter, location_filter=location_filter, job_type_filter=job_type_filter) }}" class="relative inline-flex items-center px-4 py-2 border text-sm font-medium {% if p == current_page %}bg-indigo-50 border-indigo-500 text-indigo-600 z-10{% else %}bg-white border-gray-300 text-gray-700 hover:bg-gray-50{% endif %}">
                        {{ p }}
                    </a>
                    {% endfor %}
                    {% if current_page < total_pages %}
                    <a href="{{ url_for('dashboard', page=current_page+1, sort_by=sort_by, sort_order=sort_order, search_query=search_query, status_filter=status_filter, location_filter=location_filter, job_type_filter=job_type_filter) }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">Next</a>
                    {% endif %}
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Job Status Update -->
<div id="status-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Update Job Status</h3>
        <form id="status-form" action="{{ url_for('update_job_status') }}" method="POST">
            <input type="hidden" name="job_id" id="status-job-id">
            <div class="mb-4">
                <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                <select id="status" name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <option value="new">New</option>
                    <option value="applied">Applied</option>
                    <option value="interview">Interview</option>
                    <option value="rejected">Rejected</option>
                    <option value="offered">Offered</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                <textarea id="notes" name="notes" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
            </div>
            <div class="flex justify-end space-x-4">
                <button type="button" onclick="closeStatusModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal for Assisted Apply -->
<div id="apply-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white text-center">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Assisted Apply</h3>
        <p class="text-gray-700 mb-4">This will start an automated browser session to fill out the form for you.</p>
        <p class="text-sm text-red-500 mb-4 font-semibold">
            Warning: This feature requires a local Celery worker with Selenium configured correctly. A new browser window will open.
        </p>
        <div class="flex justify-center space-x-4">
            <button type="button" onclick="closeApplyModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancel</button>
            <button type="button" id="start-apply-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Start Automation</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle New Search button
        const searchForm = document.getElementById('search-form');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const taskStatus = document.getElementById('task-status');

        if (searchForm) {
            searchForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(searchForm);
                const params = new URLSearchParams(formData).toString();
                
                progressContainer.classList.remove('hidden');
                taskStatus.textContent = 'Starting search...';
                progressBar.style.width = '0%';
                
                try {
                    const response = await fetch('/search_jobs', {
                        method: 'POST',
                        body: params,
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        checkTaskStatus(data.task_id);
                    } else {
                        taskStatus.textContent = data.message;
                        progressBar.style.width = '100%';
                        progressBar.classList.add('bg-red-500');
                    }
                } catch (error) {
                    console.error('Error starting task:', error);
                    taskStatus.textContent = 'Failed to connect to backend.';
                    progressBar.style.width = '100%';
                    progressBar.classList.add('bg-red-500');
                }
            });
        }

        // Handle Saved Profile "Apply" button
        const applyProfileForms = document.querySelectorAll('.apply-profile-form');
        applyProfileForms.forEach(form => {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(form);
                const url = form.action;
                
                progressContainer.classList.remove('hidden');
                taskStatus.textContent = 'Applying saved profile...';
                progressBar.style.width = '0%';
                
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        taskStatus.textContent = `Applying profile: ${data.profile_name}`;
                        checkTaskStatus(data.task_id);
                    } else {
                        taskStatus.textContent = data.message;
                        progressBar.style.width = '100%';
                        progressBar.classList.add('bg-red-500');
                    }
                } catch (error) {
                    console.error('Error applying profile:', error);
                    taskStatus.textContent = 'Failed to connect to backend.';
                    progressBar.style.width = '100%';
                    progressBar.classList.add('bg-red-500');
                }
            });
        });

        // Function to check task status
        function checkTaskStatus(taskId) {
            const interval = setInterval(async () => {
                const response = await fetch(`/task_status/${taskId}`);
                const data = await response.json();
                
                if (data.state === 'SUCCESS') {
                    clearInterval(interval);
                    taskStatus.textContent = data.status;
                    progressBar.style.width = '100%';
                    progressBar.classList.remove('bg-red-500');
                    progressBar.classList.add('bg-green-500');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else if (data.state === 'FAILURE') {
                    clearInterval(interval);
                    taskStatus.textContent = data.status;
                    progressBar.style.width = '100%';
                    progressBar.classList.add('bg-red-500');
                } else {
                    taskStatus.textContent = data.status;
                    progressBar.style.width = `${data.progress}%`;
                }
            }, 2000); // Poll every 2 seconds
        }

        // The new filter form handles submission via a standard GET request, so no extra JS is needed for it.

        // Modals Logic
        const statusModal = document.getElementById('status-modal');
        const applyModal = document.getElementById('apply-modal');

        window.openStatusModal = function(jobId, status, notes) {
            document.getElementById('status-job-id').value = jobId;
            document.getElementById('status').value = status;
            document.getElementById('notes').value = notes;
            statusModal.classList.remove('hidden');
        };

        window.closeStatusModal = function() {
            statusModal.classList.add('hidden');
        };

        window.openApplyModal = function(jobId, jobLink) {
            const startApplyBtn = document.getElementById('start-apply-btn');
            startApplyBtn.onclick = function() {
                startApplyProcess(jobId);
                closeApplyModal();
            };
            applyModal.classList.remove('hidden');
        };

        window.closeApplyModal = function() {
            applyModal.classList.add('hidden');
        };

        async function startApplyProcess(jobId) {
            try {
                const response = await fetch(`/assisted_apply/${jobId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    alert(data.message); // Using native alert here for a quick, non-disruptive feedback. You should replace this with a custom modal.
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error triggering assisted apply:', error);
                alert('An error occurred. Please check the console.');
            }
        }

        // Chart.js Logic
        async function renderJobStatusChart() {
            try {
                const response = await fetch('/api/job_status_data');
                if (!response.ok) {
                    console.error('Failed to fetch chart data');
                    return;
                }
                const data = await response.json();

                // Check if there's any data to display
                const totalJobsForChart = Object.values(data).reduce((a, b) => a + b, 0);
                if (totalJobsForChart === 0) {
                    document.getElementById('jobStatusChart').parentElement.innerHTML = '<p class="text-center text-gray-500">No job data to display. Start a search to see your application pipeline!</p>';
                    return;
                }
                
                const chartData = {
                    labels: Object.keys(data).map(s => s.charAt(0).toUpperCase() + s.slice(1)), // Capitalize labels
                    datasets: [{
                        label: 'Job Statuses',
                        data: Object.values(data),
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.7)',  // New (Blue)
                            'rgba(16, 185, 129, 0.7)', // Applied (Green)
                            'rgba(245, 158, 11, 0.7)',  // Interview (Amber)
                            'rgba(239, 68, 68, 0.7)',   // Rejected (Red)
                            'rgba(139, 92, 246, 0.7)'   // Offered (Violet)
                        ],
                        borderColor: [
                            '#FFFFFF'
                        ],
                        borderWidth: 2
                    }]
                };

                const ctx = document.getElementById('jobStatusChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering chart:', error);
            }
        }

        renderJobStatusChart();
    });
</script>
{% endblock %}
