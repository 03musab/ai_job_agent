{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<!-- Toast Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="toastContainer"></div>
</div>

<style>
.card {
  border-radius: 1rem;
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
}
.badge-status {
  font-size: 0.8rem;
  padding: 0.4em 0.6em;
  border-radius: 0.5rem;
}
.toast-body {
  font-size: 0.9rem;
}
</style>

<div class="row mb-4">
    <div class="col-12">
        <h1 class="text-center text-primary mb-4">
            <i class="fas fa-user-circle me-2" aria-hidden="true"></i><span class="visually-hidden">Welcome,</span>Welcome, {{ current_user.username }}!
        </h1>
    </div>
</div>

<div class="row">
    <!-- Find Jobs with collapsible Save Profile -->
    <div class="col-md-12 mb-4">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-search me-2"></i> Find New Jobs</span>
                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#saveProfileForm">Save Search Profile</button>
            </div>
            <div class="card-body">
                <!-- Search Form -->
                <form method="POST" action="{{ url_for('search_jobs') }}" class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="search_terms" class="form-label">Search Terms (comma-separated)</label>
                        <input type="text" class="form-control rounded-pill" id="search_terms" name="search_terms" placeholder="e.g., Python, Data Scientist, AI" required>
                    </div>
                    <div class="col-md-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control rounded-pill" id="location" name="location" placeholder="e.g., New York, Remote">
                    </div>
                    <div class="col-md-2">
                        <label for="experience" class="form-label">Experience</label>
                        <input type="text" class="form-control rounded-pill" id="experience" name="experience" placeholder="e.g., 2-5 years, Senior">
                    </div>
                    <div class="col-md-2">
                        <label for="job_type" class="form-label">Job Type</label>
                        <input type="text" class="form-control rounded-pill" id="job_type" name="job_type" placeholder="e.g., Full-time, Internship">
                    </div>
                    <div class="col-md-1 d-grid">
                        <button type="submit" class="btn btn-primary rounded-pill" aria-label="Search">
                            <i class="fas fa-paper-plane" aria-hidden="true"></i>
                        </button>
                    </div>
                </form>

                <!-- Collapsible Save Profile -->
                <div id="saveProfileForm" class="collapse mt-4">
                    <form method="POST" action="{{ url_for('save_profile') }}" class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="profile_name" class="form-label">Profile Name</label>
                            <input type="text" class="form-control rounded-pill" id="profile_name" name="profile_name" placeholder="e.g., My Python Jobs" required>
                        </div>
                        <div class="col-md-3">
                            <label for="search_terms_profile" class="form-label">Search Terms (comma-separated)</label>
                            <input type="text" class="form-control rounded-pill" id="search_terms_profile" name="search_terms" placeholder="e.g., Python, Data Scientist, AI" required>
                        </div>
                        <div class="col-md-2">
                            <label for="location_profile" class="form-label">Location</label>
                            <input type="text" class="form-control rounded-pill" id="location_profile" name="location" placeholder="e.g., New York, Remote" required>
                        </div>
                        <div class="col-md-2">
                            <label for="experience_profile" class="form-label">Experience</label>
                            <input type="text" class="form-control rounded-pill" id="experience_profile" name="experience" placeholder="e.g., 2-5 years, Senior" required>
                        </div>
                        <div class="col-md-1">
                            <label for="job_type_profile" class="form-label">Job Type</label>
                            <input type="text" class="form-control rounded-pill" id="job_type_profile" name="job_type" placeholder="e.g., Full-time" required>
                        </div>
                        <div class="col-md-1 d-grid">
                            <button type="submit" class="btn btn-outline-success rounded-pill">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Saved Search Profiles Section -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-bookmark me-2" aria-hidden="true"></i>Saved Search Profiles
            </div>
            <div class="card-body">
                {% if saved_profiles %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Terms</th>
                                <th>Keywords</th>
                                <th>Location</th>
                                <th>Experience</th>
                                <th>Job Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for profile in saved_profiles %}
                            <tr>
                                <td>{{ profile.profile_name }}</td>
                                <td>{{ profile.search_terms }}</td>
                                <td>
                                    {% set keywords = profile.search_terms.split(',') %}
                                    {% for kw in keywords %}
                                        <span class="badge bg-info text-dark me-1">{{ kw.strip() }}</span>
                                    {% endfor %}
                                </td>
                                <td>{{ profile.location }}</td>
                                <td>{{ profile.experience }}</td>
                                <td>{{ profile.job_type }}</td>
                                <td>
                                    <form action="{{ url_for('apply_profile', profile_id=profile.id) }}" method="POST" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-info me-2 rounded-pill" title="Apply this profile" data-bs-toggle="tooltip"><i class="fas fa-play" aria-hidden="true"></i> <span class="visually-hidden">Apply</span> Apply</button>
                                    </form>
                                    <form action="{{ url_for('delete_profile', profile_id=profile.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this profile?');">
                                        <button type="submit" class="btn btn-sm btn-danger rounded-pill" title="Delete this profile" data-bs-toggle="tooltip"><i class="fas fa-trash" aria-hidden="true"></i> <span class="visually-hidden">Delete</span> Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">No search profiles saved yet. Save one above!</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Email Settings Collapsed -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-envelope me-2" aria-hidden="true"></i> Email Notification Settings
            </div>
            <div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('update_settings') }}">
                        <div class="mb-3">
                            <label for="email_recipients" class="form-label">Recipient Email(s) (comma-separated)</label>
                            <input type="text" class="form-control rounded-pill" id="email_recipients" name="email_recipients" value="{{ user_settings.email_recipients if user_settings else '' }}" placeholder="your_email@example.com, another@example.com">
                            <div class="form-text">Emails where you want to receive job alerts.</div>
                        </div>
                        <div class="mb-3">
                            <label for="email_frequency" class="form-label">Email Frequency</label>
                            <select class="form-select rounded-pill" id="email_frequency" name="email_frequency">
                                <option value="daily" {% if user_settings and user_settings.email_frequency == 'daily' %}selected{% endif %}>Daily</option>
                                <option value="weekly" {% if user_settings and user_settings.email_frequency == 'weekly' %}selected{% endif %}>Weekly</option>
                                <option value="never" {% if user_settings and user_settings.email_frequency == 'never' %}selected{% endif %}>Never</option>
                            </select>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="send_excel_attachment" name="send_excel_attachment" {% if user_settings and user_settings.send_excel_attachment %}checked{% endif %}>
                            <label class="form-check-label" for="send_excel_attachment">
                                Attach Excel report to emails
                            </label>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary rounded-pill">Update Settings</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Listings Section -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-briefcase me-2" aria-hidden="true"></i>Your Job Listings (Total: {{ total_jobs }})
            </div>
            <div class="card-body">
                <div class="row mb-3 align-items-center">
                    <div class="col-md-5">
                        <form method="GET" action="{{ url_for('dashboard') }}" class="d-flex">
                            <input type="hidden" name="sort_by" value="{{ sort_by }}">
                            <input type="hidden" name="sort_order" value="{{ sort_order }}">
                            <input type="hidden" name="status_filter" value="{{ status_filter }}">
                            <input type="hidden" name="limit" value="{{ limit }}">
                            <input type="search" class="form-control rounded-pill me-2" name="search_query" placeholder="Search jobs..." value="{{ search_query }}" aria-label="Search jobs">
                            <button type="submit" class="btn btn-outline-secondary rounded-pill me-2" aria-label="Apply search">
                                <i class="fas fa-search" aria-hidden="true"></i>
                            </button>
                            <a class="btn btn-outline-light text-secondary border rounded-pill" href="{{ url_for('dashboard', page=1, limit=limit, sort_by='found_date', sort_order='DESC', search_query='', status_filter='all') }}" title="Clear filters" data-bs-toggle="tooltip">
                                <i class="fas fa-undo" aria-hidden="true"></i>
                                <span class="d-none d-md-inline">Clear</span>
                            </a>
                        </form>
                    </div>
                    <div class="col-md-3">
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle rounded-pill w-100" type="button" id="dropdownSortBy" data-bs-toggle="dropdown" aria-expanded="false">
                                Sort by: {{ sort_by.replace('_', ' ').title() }} <i class="fas fa-{{ 'arrow-up' if sort_order == 'ASC' else 'arrow-down' }}" aria-hidden="true"></i>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownSortBy">
                                <li><a class="dropdown-item" href="{{ url_for('dashboard', sort_by='found_date', sort_order='DESC', page=current_page, limit=limit, search_query=search_query, status_filter=status_filter) }}">Date Found (Newest)</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('dashboard', sort_by='found_date', sort_order='ASC', page=current_page, limit=limit, search_query=search_query, status_filter=status_filter) }}">Date Found (Oldest)</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('dashboard', sort_by='relevance_score', sort_order='DESC', page=current_page, limit=limit, search_query=search_query, status_filter=status_filter) }}">Relevance (High to Low)</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('dashboard', sort_by='relevance_score', sort_order='ASC', page=current_page, limit=limit, search_query=search_query, status_filter=status_filter) }}">Relevance (Low to High)</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('dashboard', sort_by='title', sort_order='ASC', page=current_page, limit=limit, search_query=search_query, status_filter=status_filter) }}">Title (A-Z)</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('dashboard', sort_by='company', sort_order='ASC', page=current_page, limit=limit, search_query=search_query, status_filter=status_filter) }}">Company (A-Z)</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle rounded-pill w-100" type="button" id="dropdownStatusFilter" data-bs-toggle="dropdown" aria-expanded="false">
                                Status: {{ status_filter.replace('_', ' ').title() }}
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownStatusFilter">
                                <li><a class="dropdown-item" href="{{ url_for('dashboard', sort_by=sort_by, sort_order=sort_order, page=current_page, limit=limit, search_query=search_query, status_filter='all') }}">All</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('dashboard', sort_by=sort_by, sort_order=sort_order, page=current_page, limit=limit, search_query=search_query, status_filter='new') }}">New</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('dashboard', sort_by=sort_by, sort_order=sort_order, page=current_page, limit=limit, search_query=search_query, status_filter='applied') }}">Applied</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('dashboard', sort_by=sort_by, sort_order=sort_order, page=current_page, limit=limit, search_query=search_query, status_filter='interview') }}">Interview</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('dashboard', sort_by=sort_by, sort_order=sort_order, page=current_page, limit=limit, search_query=search_query, status_filter='rejected') }}">Rejected</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('dashboard', sort_by=sort_by, sort_order=sort_order, page=current_page, limit=limit, search_query=search_query, status_filter='offered') }}">Offered</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle rounded-pill w-100" type="button" id="dropdownLimit" data-bs-toggle="dropdown" aria-expanded="false">
                                Per page: {{ limit }}
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownLimit">
                                {% for size in [10, 20, 50, 100] %}
                                <li><a class="dropdown-item" href="{{ url_for('dashboard', page=1, limit=size, sort_by=sort_by, sort_order=sort_order, search_query=search_query, status_filter=status_filter) }}">{{ size }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>

                {% if jobs %}
                <div class="table-responsive">
                    <form id="jobsForm" method="POST">
                        <div class="mb-3 d-flex align-items-center">
                            <button id="deleteSelectedBtn" type="submit" formaction="{{ url_for('delete_selected') }}" class="btn btn-danger me-2" onclick="return confirm('Are you sure you want to delete the selected jobs?');">Delete Selected</button>
                            <button type="submit" formaction="{{ url_for('delete_all_jobs') }}" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete ALL jobs? This cannot be undone.');">Delete All</button>
                            <span class="ms-3 text-muted" id="selectedCount">0 selected</span>
                        </div>
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll" onclick="toggleAll(this)" aria-label="Select all on page"></th>
                                    <th>Title</th>
                                    <th>Company</th>
                                    <th>Location</th>
                                    <th>Relevance</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for job in jobs %}
                                <tr data-job-id="{{ job.id }}">
                                    <td><input type="checkbox" name="job_ids" value="{{ job.id }}" aria-label="Select job {{ job.title }} at {{ job.company }}"></td>
                                    <td>
                                        <a href="{{ job.link }}" target="_blank" class="text-decoration-none text-primary fw-bold" rel="noopener noreferrer">{{ job.title }}</a>
                                    </td>
                                    <td>{{ job.company }}</td>
                                    <td>{{ job.location }}</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar {% if job.relevance_score >= 60 %}bg-success{% elif job.relevance_score >= 30 %}bg-warning text-dark{% else %}bg-danger{% endif %}"
                                                 role="progressbar"
                                                 style="width: {{ job.relevance_score | round(0) }}%;"
                                                 aria-valuenow="{{ job.relevance_score | round(0) }}" aria-valuemin="0" aria-valuemax="100">
                                                {{ job.relevance_score | round(0) }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="statusDropdown{{ job.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                                {{ job.status | title }}
                                            </button>
                                            <ul class="dropdown-menu" aria-labelledby="statusDropdown{{ job.id }}">
                                                <li><a class="dropdown-item" href="#" onclick="updateJobStatus({{ job.id }}, 'new', {{ (job.notes | default('')) | tojson | safe }})">New</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="updateJobStatus({{ job.id }}, 'applied', {{ (job.notes | default('')) | tojson | safe }})">Applied</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="updateJobStatus({{ job.id }}, 'interview', {{ (job.notes | default('')) | tojson | safe }})">Interview</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="updateJobStatus({{ job.id }}, 'rejected', {{ (job.notes | default('')) | tojson | safe }})">Rejected</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="updateJobStatus({{ job.id }}, 'offered', {{ (job.notes | default('')) | tojson | safe }})">Offered</a></li>
                                            </ul>
                                        </div>
                                    </td>
                                    <td>
                                        <!-- Job Table Actions Dropdown -->
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#jobDetailsModal" onclick="openJobModal(this)" data-job='{{ {
                                                    "id": job.id,
                                                    "title": job.title,
                                                    "company": job.company,
                                                    "location": job.location,
                                                    "salary": job.salary,
                                                    "experience": job.experience,
                                                    "min_experience_years": job.min_experience_years,
                                                    "max_experience_years": job.max_experience_years,
                                                    "job_type": job.job_type,
                                                    "posted_date": job.posted_date,
                                                    "source": job.source,
                                                    "relevance_score": job.relevance_score,
                                                    "keywords": job.keywords,
                                                    "skills": job.skills,
                                                    "extracted_tools": job.extracted_tools,
                                                    "extracted_soft_skills": job.extracted_soft_skills,
                                                    "status": job.status,
                                                    "user_feedback": job.user_feedback,
                                                    "link": job.link,
                                                    "description": job.description | clean_desc,
                                                    "notes": job.notes
                                                } | tojson | safe }}'>
                                                <i class="fas fa-info-circle"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"></button>
                                            <ul class="dropdown-menu">
                                                <li>
                                                    <form action="{{ url_for('feedback') }}" method="POST">
                                                        <input type="hidden" name="job_id" value="{{ job.id }}">
                                                        <button type="submit" name="feedback_type" value="like" class="dropdown-item"><i class="fas fa-thumbs-up text-success"></i> Like</button>
                                                    </form>
                                                </li>
                                                <li>
                                                    <form action="{{ url_for('feedback') }}" method="POST">
                                                        <input type="hidden" name="job_id" value="{{ job.id }}">
                                                        <button type="submit" name="feedback_type" value="dislike" class="dropdown-item"><i class="fas fa-thumbs-down text-danger"></i> Dislike</button>
                                                    </form>
                                                </li>
                                                <li>
                                                    <button type="button" class="dropdown-item" onclick="copyToClipboard({{ job.link | tojson | safe }}, this)"><i class="fas fa-link"></i> Copy Link</button>
                                                </li>
                                                <li>
                                                    <form action="{{ url_for('delete_job', job_id=job.id) }}" method="POST" onsubmit="return confirm('Delete?');">
                                                        <button type="submit" class="dropdown-item text-danger"><i class="fas fa-trash"></i> Delete</button>
                                                    </form>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </form>
                </div>

                <!-- Single Reusable Job Details Modal -->
                <div class="modal fade" id="jobDetailsModal" tabindex="-1" aria-labelledby="jobDetailsModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="jobDetailsModalLabel">Job Details</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p><strong>Company:</strong> <span id="modalCompany"></span></p>
                                <p><strong>Location:</strong> <span id="modalLocation"></span></p>
                                <p><strong>Salary:</strong> <span id="modalSalary"></span></p>
                                <p><strong>Experience:</strong> <span id="modalExperience"></span> (Min: <span id="modalMinExp"></span> yrs, Max: <span id="modalMaxExp"></span> yrs)</p>
                                <p><strong>Job Type:</strong> <span id="modalJobType"></span></p>
                                <p><strong>Posted Date:</strong> <span id="modalPostedDate"></span></p>
                                <p><strong>Source:</strong> <span id="modalSource"></span></p>
                                <p><strong>Relevance Score:</strong> <span id="modalRelevance"></span>%</p>
                                <p><strong>Keywords:</strong> <span id="modalKeywords"></span></p>
                                <p><strong>Skills:</strong> <span id="modalSkills"></span></p>
                                <p><strong>Extracted Tools:</strong> <span id="modalTools"></span></p>
                                <p><strong>Extracted Soft Skills:</strong> <span id="modalSoftSkills"></span></p>
                                <p><strong>Current Status:</strong> <span id="modalStatus"></span></p>
                                <p><strong>User Feedback:</strong> <span id="modalFeedback"></span></p>
                                <hr>
                                <h6>Description:</h6>
                                <p id="modalDescription" style="white-space: pre-wrap;"></p>
                                <hr>
                                <h6>Your Notes:</h6>
                                <form id="modalNotesForm" action="{{ url_for('update_job_status') }}" method="POST">
                                    <input type="hidden" name="job_id" id="modalJobIdInput" value="">
                                    <input type="hidden" name="status" id="modalStatusInput" value="">
                                    <textarea class="form-control" name="notes" id="modalNotesTextarea" rows="3" placeholder="Add your notes here..."></textarea>
                                    <button type="submit" class="btn btn-sm btn-secondary mt-2">Save Notes</button>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <a href="#" target="_blank" class="btn btn-success" id="modalApplyLink" rel="noopener noreferrer"><i class="fas fa-external-link-alt me-1" aria-hidden="true"></i> Apply Now</a>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                    function toggleAll(source) {
                        const checkboxes = document.querySelectorAll('input[name="job_ids"]');
                        checkboxes.forEach(cb => cb.checked = source.checked);
                        updateSelectionState();
                    }

                    function updateSelectionState() {
                        const checkboxes = Array.from(document.querySelectorAll('input[name="job_ids"]'));
                        const selectAll = document.getElementById('selectAll');
                        const count = checkboxes.filter(cb => cb.checked).length;
                        const total = checkboxes.length;
                        const countEl = document.getElementById('selectedCount');
                        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');

                        if (countEl) countEl.textContent = count + ' selected';
                        if (deleteSelectedBtn) deleteSelectedBtn.disabled = count === 0;

                        // Update select-all checkbox state
                        if (selectAll) {
                            selectAll.indeterminate = count > 0 && count < total;
                            selectAll.checked = count > 0 && count === total;
                        }
                    }

                    function openJobModal(triggerEl) {
                        const dataRaw = triggerEl.getAttribute('data-job');
                        if (!dataRaw) return;
                        let job;
                        try { job = JSON.parse(dataRaw); } catch (e) { return; }

                        // Title
                        const titleEl = document.getElementById('jobDetailsModalLabel');
                        titleEl.textContent = job.title || 'Job Details';

                        // Simple fields
                        document.getElementById('modalCompany').textContent = job.company || 'N/A';
                        document.getElementById('modalLocation').textContent = job.location || 'N/A';
                        document.getElementById('modalSalary').textContent = job.salary || 'N/A';
                        document.getElementById('modalExperience').textContent = job.experience || 'N/A';
                        document.getElementById('modalMinExp').textContent = (job.min_experience_years ?? 'N/A');
                        document.getElementById('modalMaxExp').textContent = (job.max_experience_years ?? 'N/A');
                        document.getElementById('modalJobType').textContent = job.job_type || 'N/A';
                        document.getElementById('modalPostedDate').textContent = job.posted_date || 'N/A';
                        document.getElementById('modalSource').textContent = job.source || 'N/A';
                        const rel = Number(job.relevance_score);
                        document.getElementById('modalRelevance').textContent = isNaN(rel) ? 'N/A' : rel.toFixed(2);
                        document.getElementById('modalKeywords').textContent = job.keywords || 'N/A';
                        document.getElementById('modalSkills').textContent = job.skills || 'N/A';
                        document.getElementById('modalTools').textContent = job.extracted_tools || 'N/A';
                        document.getElementById('modalSoftSkills').textContent = job.extracted_soft_skills || 'N/A';
                        document.getElementById('modalStatus').textContent = (job.status || 'N/A');
                        document.getElementById('modalFeedback').textContent = job.user_feedback ? (job.user_feedback.charAt(0).toUpperCase() + job.user_feedback.slice(1)) : 'None';

                        // Description
                        document.getElementById('modalDescription').textContent = job.description || '';

                        // Notes form
                        document.getElementById('modalJobIdInput').value = job.id;
                        document.getElementById('modalStatusInput').value = job.status || '';
                        document.getElementById('modalNotesTextarea').value = job.notes || '';

                        // Apply link
                        const linkEl = document.getElementById('modalApplyLink');
                        linkEl.href = job.link || '#';
                    }
                </script>

                <!-- Pagination -->
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('dashboard', page=current_page - 1, limit=limit, sort_by=sort_by, sort_order=sort_order, search_query=search_query, status_filter=status_filter) }}">Previous</a>
                        </li>
                        {% for page_num in range(1, total_pages + 1) %}
                            <li class="page-item {% if page_num == current_page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('dashboard', page=page_num, limit=limit, sort_by=sort_by, sort_order=sort_order, search_query=search_query, status_filter=status_filter) }}">{{ page_num }}</a>
                            </li>
                        {% endfor %}
                        <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('dashboard', page=current_page + 1, limit=limit, sort_by=sort_by, sort_order=sort_order, search_query=search_query, status_filter=status_filter) }}">Next</a>
                        </li>
                    </ul>
                </nav>

                {% else %}
                <p class="text-muted text-center">No jobs found matching your criteria. Try a new search or apply a saved profile!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    function showToast(message, type='success') {
        const toastId = 'toast' + Date.now();
        const toastHTML = `
<div id="${toastId}" class="toast align-items-center text-bg-${type} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
  <div class="d-flex">
    <div class="toast-body">${message}</div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
  </div>
</div>`;
        document.getElementById('toastContainer').insertAdjacentHTML('beforeend', toastHTML);
        const toastEl = document.getElementById(toastId);
        new bootstrap.Toast(toastEl, { delay: 3000 }).show();
    }

    function updateJobStatus(jobId, newStatus, currentNotes) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("update_job_status") }}';

        const jobIdInput = document.createElement('input');
        jobIdInput.type = 'hidden';
        jobIdInput.name = 'job_id';
        jobIdInput.value = jobId;
        form.appendChild(jobIdInput);

        const statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'status';
        statusInput.value = newStatus;
        form.appendChild(statusInput);

        const notesInput = document.createElement('input');
        notesInput.type = 'hidden';
        notesInput.name = 'notes';
        notesInput.value = (currentNotes == null) ? '' : currentNotes; // Preserve current notes safely
        form.appendChild(notesInput);

        document.body.appendChild(form);
        form.submit();
    }

    function copyToClipboard(text, triggerEl) {
        const fallback = () => {
            const tempInput = document.createElement('input');
            tempInput.style.position = 'absolute';
            tempInput.style.left = '-9999px';
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
        };
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).catch(fallback).then(() => showToast('Link copied', 'success'));
        } else {
            fallback();
            showToast('Link copied', 'success');
        }
        // If there's a tooltip, show feedback
        if (window.bootstrap && triggerEl) {
            const tt = bootstrap.Tooltip.getInstance(triggerEl) || new bootstrap.Tooltip(triggerEl);
            const prev = triggerEl.getAttribute('data-bs-original-title') || triggerEl.getAttribute('title') || '';
            triggerEl.setAttribute('data-bs-original-title', 'Copied!');
            tt.show();
            setTimeout(() => {
                triggerEl.setAttribute('data-bs-original-title', prev);
                tt.hide();
            }, 1000);
        }
    }

    function highlightSearchTerms(query) {
        if (!query) return;
        const terms = query.split(/[\s,]+/).map(t => t.trim()).filter(t => t.length > 1);
        if (!terms.length) return;
        const anchors = document.querySelectorAll('table tbody a.text-primary.fw-bold');
        anchors.forEach(a => {
            const text = a.textContent;
            let html = text;
            terms.forEach(term => {
                const esc = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const pattern = new RegExp('(' + esc + ')', 'ig');
                html = html.replace(pattern, '<mark>$1</mark>');
            });
            a.innerHTML = html;
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Enable tooltips
        if (window.bootstrap) {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        // Bootstrap toasts container requires class 'toast' elements, they are added dynamically by showToast

        // Disable submit buttons on submit + show spinner icon
        document.querySelectorAll('form').forEach(function (form) {
            form.addEventListener('submit', function () {
                this.querySelectorAll('button[type="submit"]').forEach(function (btn) {
                    btn.disabled = true;
                    const icon = btn.querySelector('i');
                    if (icon) {
                        icon.classList.add('fa-spinner', 'fa-spin');
                    }
                });
            });
        });

        // Highlight search terms in titles
        highlightSearchTerms({{ (search_query or '') | tojson | safe }});

        // Initialize selection state listeners
        const jobCheckboxes = document.querySelectorAll('input[name="job_ids"]');
        jobCheckboxes.forEach(cb => cb.addEventListener('change', updateSelectionState));
        // Initial computation
        updateSelectionState();
    });
</script>
{% endblock %}
