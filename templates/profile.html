{% extends "base.html" %}
{% block body_class %}light-theme{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-8 md:p-12">
    <div class="text-center mb-10" role="main" aria-labelledby="page-title">
        <h1 id="page-title" class="text-3xl font-bold text-gray-900">Your Profile</h1>
        <p class="mt-2 text-gray-600">Keep your application details up-to-date for seamless job hunting.</p>
    </div>

    <form id="main-profile-form" action="{{ url_for('profile') }}" method="POST" enctype="multipart/form-data" class="space-y-8">
        
        <!-- Personal Information -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="full_name" class="block text-sm font-medium text-gray-700">Full Name</label>
                <input type="text" name="full_name" id="full_name" value="{{ user_details.full_name if user_details else '' }}" autocomplete="name" class="mt-1 block w-full rounded-lg bg-white border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-gray-900 placeholder-gray-400 transition-all duration-200 pl-4" style="border-radius: 0.25rem;">
            </div>
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" name="email" id="email" value="{{ user_details.email if user_details else '' }}" autocomplete="email" class="mt-1 block w-full rounded-lg bg-white border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-gray-900 placeholder-gray-400 transition-all duration-200 pl-4" style="border-radius: 0.25rem;">
            </div>
            <div>
                <label for="phone" class="block text-sm font-medium text-gray-700">Phone</label>
                <input type="tel" name="phone" id="phone" value="{{ user_details.phone if user_details else '' }}" autocomplete="tel" class="mt-1 block w-full rounded-lg bg-white border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-gray-900 placeholder-gray-400 transition-all duration-200 pl-4" style="border-radius: 0.25rem;">
            </div>
            <div>
                <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                <input type="text" name="address" id="address" value="{{ user_details.address if user_details else '' }}" autocomplete="street-address" class="mt-1 block w-full rounded-lg bg-white border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-gray-900 placeholder-gray-400 transition-all duration-200 pl-4" style="border-radius: 0.25rem;">
            </div>
        </div>

        <!-- Professional Links -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div>
                <label for="linkedin_url" class="block text-sm font-medium text-gray-700">LinkedIn URL</label>
                <input type="url" name="linkedin_url" id="linkedin_url" value="{{ user_details.linkedin_url if user_details else '' }}" autocomplete="url" class="mt-1 block w-full rounded-lg bg-white border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-gray-900 placeholder-gray-400 transition-all duration-200 pl-4" style="border-radius: 0.25rem;">
            </div>
            <div>
                <label for="github_url" class="block text-sm font-medium text-gray-700">GitHub URL</label>
                <input type="url" name="github_url" id="github_url" value="{{ user_details.github_url if user_details else '' }}" autocomplete="url" class="mt-1 block w-full rounded-lg bg-white border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-gray-900 placeholder-gray-400 transition-all duration-200 pl-4" style="border-radius: 0.25rem;">
            </div>
            <div>
                <label for="portfolio_url" class="block text-sm font-medium text-gray-700">Portfolio URL</label>
                <input type="url" name="portfolio_url" id="portfolio_url" value="{{ user_details.portfolio_url if user_details else '' }}" autocomplete="url" class="mt-1 block w-full rounded-lg bg-white border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-gray-900 placeholder-gray-400 transition-all duration-200 pl-4" style="border-radius: 0.25rem;">
            </div>
        </div>

        <!-- Resume and Cover Letter -->
        <div>
            <label for="resume" class="block text-sm font-medium text-gray-700">Upload Resume</label>
            <div id="resume-drop-zone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-blue-200 border-dashed rounded-lg bg-blue-50 shadow-sm transition-colors duration-200 hover:bg-blue-100 hover:border-blue-300" style="border-radius: 0.5rem;">
                <div class="space-y-1 text-center">
                    <svg class="mx-auto h-12 w-12 text-blue-500" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" />
                    </svg>
                    <div class="flex text-sm text-gray-700">
                        <label for="resume" class="relative cursor-pointer bg-transparent rounded-md font-medium text-blue-600 hover:text-blue-800 focus-within:outline-none" style="border-radius: 0.25rem;">
                            <span id="resume-upload-text">Upload a file</span>
                            <input id="resume" name="resume" type="file" class="sr-only">
                        </label>
                        <p class="pl-1 text-gray-500">or drag and drop</p>
                    </div>
                    <p class="text-xs text-gray-500">PDF, DOCX up to 10MB</p>
                </div>
            </div>
            <!-- Placeholder for currently saved file -->
            {% if user_details and user_details.resume_path %}
            <div id="current-file-display" class="mt-2 flex items-center justify-center gap-4">
                <p id="current-file-text" class="text-sm text-green-600">Current file: <span class="font-medium">{{ user_details.resume_path.split('/')[-1].split('\\')[-1] }}</span></p>
            </div>
            {% endif %}
            <!-- Placeholder for newly uploaded file name -->
            <div id="new-file-display" class="hidden mt-3 text-center">
                <p id="new-file-name" class="text-lg text-blue-600 font-semibold"></p>
                <!-- New dedicated upload button that appears when a new file is selected -->
                <div id="upload-new-resume-container" class="mt-4" role="status" aria-live="polite">
                    <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 transition-colors shadow-lg">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.25 13.25a.75.75 0 0 0 1.5 0V4.636l2.955 3.129a.75.75 0 0 0 1.09-1.03l-4.25-4.5a.75.75 0 0 0-1.09 0l-4.25 4.5a.75.75 0 1 0 1.09 1.03L9.25 4.636v8.614Z" /><path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" /></svg>
                        Upload and Save New Resume
                    </button>
                </div>
            </div>

            <!-- AI Readability Status -->
            {% if user_details and user_details.resume_parsed_data %}
                {% set parsed_resume = user_details.resume_parsed_data | fromjson %}
                {% if parsed_resume and parsed_resume.skills %}
                <div id="ai-ready-status" class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg text-center" role="status" style="border-radius: 0.25rem;">
                    <div class="flex items-center justify-center gap-2 text-green-700 font-semibold">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" /></svg>
                        <span>Resume is AI-Ready</span>
                    </div>
                    <p class="text-xs text-gray-600 mt-1">The AI has identified the following skills to help write your cover letter:</p>
                    <div class="mt-2 flex flex-wrap justify-center gap-2">
                        {% for skill in parsed_resume.skills | slice(6) %}<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full" style="border-radius: 9999px;">{{ skill }}</span>{% endfor %}
                    </div>
                </div>
                {% endif %}
            {% endif %}
        </div>

       

        <!-- Additional Questions -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <fieldset>
                <legend class="text-sm font-medium text-gray-700">Willing to Relocate?</legend>
                <div class="mt-2 space-y-2">
                    <div class="flex items-center">
                        <input id="relocate_yes" name="willing_to_relocate" type="radio" value="yes" {% if user_details and user_details.willing_to_relocate == 'yes' %}checked{% endif %} class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 bg-white">
                        <label for="relocate_yes" class="ml-3 block text-sm font-medium text-gray-700">Yes</label>
                    </div>
                    <div class="flex items-center">
                        <input id="relocate_no" name="willing_to_relocate" type="radio" value="no" {% if not user_details or user_details.willing_to_relocate == 'no' %}checked{% endif %} class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 bg-white">
                        <label for="relocate_no" class="ml-3 block text-sm font-medium text-gray-700">No</label>
                    </div>
                    <div class="flex items-center">
                        <input id="relocate_case" name="willing_to_relocate" type="radio" value="case-by-case" {% if user_details and user_details.willing_to_relocate == 'case-by-case' %}checked{% endif %} class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 bg-white">
                        <label for="relocate_case" class="ml-3 block text-sm font-medium text-gray-700">On a case-by-case basis</label>
                    </div>
                </div>
            </fieldset>
            <fieldset>
                <legend class="text-sm font-medium text-gray-700">Legally Authorized to Work?</legend>
                <div class="mt-2 space-y-2">
                    <div class="flex items-center">
                        <input id="auth_yes" name="authorized_to_work" type="radio" value="yes" {% if user_details and user_details.authorized_to_work == 'yes' %}checked{% endif %} class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 bg-white">
                        <label for="auth_yes" class="ml-3 block text-sm font-medium text-gray-700">Yes</label>
                    </div>
                    <div class="flex items-center">
                        <input id="auth_no" name="authorized_to_work" type="radio" value="no" {% if not user_details or user_details.authorized_to_work == 'no' %}checked{% endif %} class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 bg-white">
                        <label for="auth_no" class="ml-3 block text-sm font-medium text-gray-700">No, I require sponsorship</label>
                    </div>
                </div>
                <p class="mt-2 text-xs text-gray-500">This helps answer questions about work authorization and visa sponsorship.</p>
            </fieldset>
        </div>


        <!-- Submit Button -->
        <div class="pt-8 mt-8 border-t border-gray-200">
            <div class="flex justify-between items-center">
                <button type="button" id="clear-profile-btn" class="text-sm font-medium text-red-600 hover:text-red-800 transition-colors">
                    Clear All Profile Data
                </button>
                <button type="submit" form="main-profile-form" class="btn-temporal inline-flex justify-center py-3 px-8 border border-transparent shadow-sm text-base font-medium rounded-md text-white">
                    Save Profile
                </button>
            </div>
        </div>
    </form>
    </div>
</div>

<!-- Toast Notification Placeholder -->
<div id="toast-container" class="fixed top-6 right-6 z-[1000]"></div>
<script src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>

<script>
    /**
     * Generates a cover letter template when the "AI Generate" button is clicked.
     * It uses the user's profile details and parsed resume skills to populate a template.
     */
    function generateAICoverLetter(userDetails) {
        const templates = [];
        const coverLetterTextarea = document.getElementById('cover_letter_template');
        const generateBtn = document.querySelector("button[onclick^='generateAICoverLetter']");
        const copyBtn = document.getElementById('copy-cover-letter-btn');

        const fullName = userDetails ? userDetails.full_name || '[Your Name]' : '[Your Name]';
        const email = userDetails ? userDetails.email || '[Your Email]' : '[Your Email]';
        const phone = userDetails ? userDetails.phone || '[Your Phone]' : '[Your Phone]';
        
        let skills = [];
        if (userDetails && userDetails.resume_parsed_data) {
            try {
                // Safely parse the resume data which is stored as a JSON string
                let parsedResume = userDetails.resume_parsed_data;
                // The `tojson` filter stringifies the data. We need to parse it back into an object.
                // We also check if it's already an object, just in case.
                if (typeof parsedResume === 'string') {
                    parsedResume = JSON.parse(parsedResume);
                }

                if (parsedResume && parsedResume.skills && Array.isArray(parsedResume.skills) && parsedResume.skills.length > 0) {
                    skills = parsedResume.skills;
                }
            } catch (e) {
                console.error("Could not parse resume data:", e);
            }
        }

        let skillsParagraph = "Throughout my career, I have developed a strong skill set that I believe is a great match for this role.";
        // If skills were found in the resume, create a more personalized paragraph
        if (skills.length > 0) {
            const skillsList = skills.slice(0, 5).join(', '); // Take top 5 skills
            skillsParagraph = `I am proficient in a variety of technologies and methodologies, including ${skillsList}. My experience in these areas has prepared me to tackle the challenges of this position and contribute effectively to your team.`;
        }

        // --- Template 1: The Professional ---
        templates.push(`Dear [Hiring Manager Name],

I am writing to express my enthusiastic interest in the [Job Title] position at [Company Name], which I discovered on [Platform, e.g., LinkedIn]. Having followed [Company Name]'s work for some time, I am deeply impressed by your commitment to [Company Value or Product], and I am confident that my skills and experience align perfectly with the requirements of this role.

${skillsParagraph}

I am particularly drawn to this opportunity because [Reason you are interested in the company or role]. I am eager to bring my background in [Your Key Experience Area] to your team and contribute to your continued success.

Thank you for considering my application. I have attached my resume for your review and welcome the opportunity to discuss how my qualifications can benefit [Company Name].

Sincerely,
${fullName}
${email}
${phone}`);

        // --- Template 2: The Storyteller ---
        templates.push(`Dear [Hiring Manager Name],

It is with great excitement that I submit my application for the [Job Title] role at [Company Name]. For years, I have admired your company's impact in the [Industry] space, particularly your work on [Specific Project or Product]. Your dedication to [Company Mission/Value] resonates deeply with my own professional values.

My background in [Your Key Experience Area] and my hands-on experience with skills such as ${skills.slice(0, 3).join(', ')} have prepared me to not only meet but exceed the expectations for this role. I am a collaborative problem-solver who is passionate about building solutions that make a difference.

The opportunity to contribute to your team would be a privilege. I am eager to learn more about how I can help [Company Name] achieve its future goals.

Thank you for your time and consideration.

Best regards,
${fullName}
${email}
${phone}`);

        // --- Template 3: The Achiever ---
        templates.push(`Dear [Hiring Manager Name],

I am writing to apply for the [Job Title] position at [Company Name]. With a proven track record of delivering results in [Your Field], I was immediately drawn to this opportunity to leverage my skills to drive success for your team.

In my previous role at [Previous Company], I was responsible for [Your Key Responsibility], where I successfully [Quantifiable Achievement, e.g., increased efficiency by 20% or led a project that generated $50k in revenue]. My expertise in ${skills.slice(0, 4).join(', ')} would allow me to make a direct and immediate impact at [Company Name].

I am confident that my results-oriented approach and dedication to excellence would make me a valuable asset to your organization.

I have attached my resume for your detailed review and look forward to discussing this exciting opportunity with you further.

Sincerely,
${fullName}
${email}
${phone}`);

        // --- Template 4: The Enthusiast ---
        templates.push(`Dear [Hiring Manager Name],

I was thrilled to see the opening for a [Job Title] at [Company Name] and am submitting my application with great enthusiasm.

My experience in [Your Key Experience Area] and skills in ${skills.slice(0, 3).join(', ')} are a strong match for the responsibilities outlined in the job description. I am a proactive and adaptable professional, always eager to learn and contribute to a forward-thinking team.

The prospect of joining [Company Name] is incredibly appealing, and I am confident I have the drive and expertise to excel in this role.

Thank you for your consideration. I hope to speak with you soon.

Best,
${fullName}
${email}
${phone}`);

        // Randomly select one of the templates
        const template = templates[Math.floor(Math.random() * templates.length)];

        // --- AI Animation Logic ---
        generateBtn.disabled = true;
        copyBtn.disabled = true;
        coverLetterTextarea.readOnly = true; // Prevent user input during animation
        coverLetterTextarea.value = '';
        coverLetterTextarea.placeholder = 'ðŸ¤– AI is crafting a new cover letter...';

        // 1. "Thinking" phase
        const thinkingTimeout = setTimeout(() => {
            coverLetterTextarea.placeholder = 'âœï¸ Generating your cover letter...';
            
            // 2. "Typing" phase
            let i = 0;
            const typingSpeed = 8; // milliseconds per character, slightly faster
            const typingInterval = setInterval(() => {
                if (i < template.length) {
                    // Use requestAnimationFrame for smoother rendering
                    const char = template.charAt(i);
                    requestAnimationFrame(() => {
                        coverLetterTextarea.value += char;
                        // Only scroll when needed to reduce layout calculations
                        if (coverLetterTextarea.scrollHeight > coverLetterTextarea.clientHeight) {
                            coverLetterTextarea.scrollTop = coverLetterTextarea.scrollHeight;
                        }
                    });
                    i++;
                } else {
                    clearInterval(typingInterval);
                    generateBtn.disabled = false;
                    copyBtn.disabled = false;
                    coverLetterTextarea.readOnly = false;

                    // 3. "Finished" glow effect
                    coverLetterTextarea.classList.add('glow-effect');
                    setTimeout(() => coverLetterTextarea.classList.remove('glow-effect'), 1500);
                }
            }, typingSpeed);
        }, 700); // Delay for "thinking"
    }

    // Add a CSS class for the glow effect to keep styles separate
    const style = document.createElement('style');
    style.innerHTML = `
        .glow-effect {
            transition: box-shadow 0.3s ease-in-out;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }
    `;
    document.head.appendChild(style);


    function copyCoverLetterToClipboard() {
        const textarea = document.getElementById('cover_letter_template');
        const copyButton = document.getElementById('copy-cover-letter-btn');

        if (!textarea.value) {
            alert('Nothing to copy. Generate a cover letter first.');
            return;
        }

        navigator.clipboard.writeText(textarea.value).then(() => {
            const originalContent = copyButton.innerHTML;
            copyButton.disabled = true;
            copyButton.innerHTML = `
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.052-.143Z" clip-rule="evenodd" />
                </svg>
                Copied!
            `;

            setTimeout(() => {
                copyButton.innerHTML = originalContent;
                copyButton.disabled = false;
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy text: ', err);
            alert('Failed to copy text. Please try again.');
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const resumeInput = document.getElementById('resume');
        const newFileNameDisplay = document.getElementById('new-file-name');
        const newFileDisplayContainer = document.getElementById('new-file-display');
        const currentFileText = document.getElementById('current-file-text');
        const currentFileDisplayContainer = document.getElementById('current-file-display');
        const resumeDropZone = document.getElementById('resume-drop-zone');
        const resumeUploadText = document.getElementById('resume-upload-text');
        const uploadNewResumeContainer = document.getElementById('upload-new-resume-container');

        resumeInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                const file = this.files[0];
                const fileName = file.name;
                
                // Display the new file name prominently
                newFileNameDisplay.textContent = `Selected: ${fileName}`;
                newFileDisplayContainer.classList.remove('hidden');
                uploadNewResumeContainer.classList.remove('hidden');

                // Hide the old "Current file" text if it exists
                if (currentFileDisplayContainer) {
                    currentFileDisplayContainer.classList.add('hidden');
                }
                // Update the upload button text
                resumeUploadText.textContent = 'Change file';
            }
        });

        // Add visual feedback for drag-and-drop
        ['dragenter', 'dragover'].forEach(eventName => {
            resumeDropZone.addEventListener(eventName, () => resumeDropZone.classList.add('bg-blue-100', 'border-blue-400'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            resumeDropZone.addEventListener(eventName, () => resumeDropZone.classList.remove('bg-blue-100', 'border-blue-400'), false);
        });

        // --- Clear Profile Logic ---
        const clearProfileBtn = document.getElementById('clear-profile-btn');
        if (clearProfileBtn) {
            clearProfileBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to permanently delete all your profile information? This action cannot be undone.')) {
                    fetch("{{ url_for('clear_profile') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // Add CSRF token header if your app uses it
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Clear all form fields visually
                            const form = document.getElementById('main-profile-form');
                            form.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="url"], textarea').forEach(el => el.value = '');
                            
                            // Uncheck all radio buttons and then set the default 'no' options
                            form.querySelectorAll('input[name="willing_to_relocate"]').forEach(radio => radio.checked = false);
                            const relocateNo = document.getElementById('relocate_no');
                            if (relocateNo) relocateNo.checked = true;
                            document.getElementById('auth_no').checked = true;

                            // Hide file-specific info
                            if (currentFileDisplayContainer) currentFileDisplayContainer.classList.add('hidden');
                            const aiReadyStatus = document.getElementById('ai-ready-status');
                            if (aiReadyStatus) aiReadyStatus.classList.add('hidden');

                            // Reset the resume upload UI
                            newFileDisplayContainer.classList.add('hidden');
                            uploadNewResumeContainer.classList.add('hidden');
                            resumeUploadText.textContent = 'Upload a file';

                            // Show a success toast
                            showToast('Profile data cleared successfully!', 'success');
                        } else {
                            showToast('Failed to clear profile data.', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error clearing profile:', error);
                        showToast('An error occurred. Please try again.', 'danger');
                    });
                }
            });
        }

        // --- Test Connection Logic ---
        const testConnectionBtn = document.getElementById('testConnectionBtn');
        const testResultDiv = document.getElementById('test-connection-result');
        if(testConnectionBtn) {
            testConnectionBtn.addEventListener('click', function() {
                testResultDiv.innerHTML = `
                    <div class="flex items-center gap-2 text-cyan-300">
                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <span>Testing connection...</span>
                    </div>`;
                
                fetch("{{ url_for('test_assisted_apply_connection') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        testResultDiv.innerHTML = `<div class="p-3 rounded-md bg-green-900/50 text-green-300 border border-green-500/30">${data.message}</div>`;
                    } else {
                        testResultDiv.innerHTML = `<div class="p-3 rounded-md bg-red-900/50 text-red-300 border border-red-500/30">${data.message}</div>`;
                    }
                })
                .catch(error => {
                    testResultDiv.innerHTML = `<div class="p-3 rounded-md bg-red-900/50 text-red-300 border border-red-500/30">An error occurred while testing.</div>`;
                    console.error('Error:', error);
                });
            });
        }

        // --- Open Browser Session Logic ---
        const openBrowserBtn = document.getElementById('openBrowserBtn');
        if (openBrowserBtn) {
            openBrowserBtn.addEventListener('click', function() {
                showToast('Opening browser session...', 'info');
                fetch("{{ url_for('open_browser_session') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast(data.message, 'success');
                    } else {
                        showToast(data.message, 'danger');
                    }
                }).catch(error => showToast('An error occurred.', 'danger'));
            });
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `flash-message flash-${type}`;
            toast.textContent = message;
            
            // Override the animation to control it with JS
            toast.style.animation = 'slideInRight 0.3s ease-out forwards';

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'fadeout 0.5s ease-out forwards';
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }
    });
</script>
{% endblock %}