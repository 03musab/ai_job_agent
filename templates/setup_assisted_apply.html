{% extends "base.html" %}

{% block title %}Setup Assisted Apply{% endblock %}

{% block body_class %}light-theme{% endblock %}

{% block content %}
<!-- Full-screen fixed background -->
<div class="fixed inset-0 bg-cover bg-center -z-10" style="background-image: url({{ url_for('static', filename='assets/profiletemporalbg.jpg') }});">
    <div class="absolute inset-0 bg-white/90 backdrop-blur-[4px]"></div>
</div>

<style>
/* Light Theme Overrides */
body { 
    background-color: #ffffff !important;
    color: #111827 !important;
}

body::before {
    background-image: 
        linear-gradient(rgba(99, 102, 241, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(99, 102, 241, 0.02) 1px, transparent 1px);
}

.bg-gray-900\/40 {
    background-color: rgba(255, 255, 255, 0.95) !important;
    border-color: rgba(229, 231, 235, 0.6) !important;
}

.text-gray-100 {
    color: #111827 !important;
}

.text-gray-300 {
    color: #6b7280 !important;
}

.text-gray-400 {
    color: #9ca3af !important;
}

.text-gray-500 {
    color: #6b7280 !important;
}

.text-gray-600 {
    color: #4b5563 !important;
}

.text-gray-700 {
    color: #374151 !important;
}

.border-indigo-500\/20 {
    border-color: rgba(99, 102, 241, 0.06) !important;
}

.bg-indigo-600 {
    background-color: #2563eb !important;
}

.bg-blue-50 {
    background-color: #eff6ff !important;
    border-color: #bfdbfe !important;
}

.text-blue-900 {
    color: #1e3a8a !important;
}

.border-blue-200 {
    border-color: #bfdbfe !important;
}

.bg-cyan-900\/50 {
    background-color: rgba(34, 197, 234, 0.1) !important;
}

.border-cyan-500\/30 {
    border-color: rgba(34, 197, 234, 0.2) !important;
}

.text-cyan-200 {
    color: #22d3ee !important;
}

.btn-temporal {
    background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%) !important;
    color: #fff !important;
    border-color: rgba(99, 102, 241, 0.12) !important;
    box-shadow: 0 4px 14px rgba(99, 102, 241, 0.08);
    border-radius: 0.25rem;
}

.btn-temporal:hover {
    box-shadow: 0 10px 20px rgba(99, 102, 241, 0.15);
}

.bg-green-600 {
    background-color: #16a34a !important;
}

.bg-green-600:hover {
    background-color: #15803d !important;
}

.bg-green-500 {
    background-color: #22c55e !important;
}

.text-green-500 {
    color: #22c55e !important;
}

.text-green-600 {
    color: #16a34a !important;
}

.bg-gray-200 {
    background-color: #e5e7eb !important;
    color: #111827 !important;
}

.bg-gray-200:hover {
    background-color: #d1d5db !important;
}

.bg-gray-700 {
    background-color: #e5e7eb !important;
    color: #111827 !important;
}

.bg-gray-700:hover {
    background-color: #d1d5db !important;
}

.text-gray-200 {
    color: #111827 !important;
}

.text-gray-900 {
    color: #111827 !important;
}

.shadow-inner {
    box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
}

.bg-gradient-to-r {
    background-image: linear-gradient(90deg, #06b6d4, #a855f7);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.text-red-500 {
    color: #ef4444 !important;
}

.text-red-600 {
    color: #dc2626 !important;
}

.text-amber-500 {
    color: #f59e0b !important;
}

.text-amber-600 {
    color: #d97706 !important;
}

/* Step counter circles */
.rounded-full {
    border-radius: 9999px;
}
</style>

<div class="relative max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <div class="text-center mb-10">
        <h1 class="text-4xl font-bold text-transparent bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text">Assisted Apply Setup</h1>
        <p class="mt-2 text-lg text-gray-600">Connect your browser for seamless applications.</p>
    </div>

    <div class="bg-white border border-gray-200 shadow-md backdrop-blur-md rounded-lg overflow-hidden" style="border-radius: 0.25rem;">
        <div class="p-8">
            <!-- Step 1: Instructions -->
            <div id="step1">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Step 1: Prepare Your Browser</h3>
                <p class="text-gray-600 mb-6">This wizard will launch a new browser window. Please log in to LinkedIn to securely connect your session.</p>
                <ol class="space-y-3 text-gray-700">
                    <li class="flex items-start gap-3">
                        <span class="flex-shrink-0 w-6 h-6 text-sm flex items-center justify-center rounded-full bg-blue-600 text-white font-bold">1</span>
                        <span>Click the "Start Setup" button below.</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <span class="flex-shrink-0 w-6 h-6 text-sm flex items-center justify-center rounded-full bg-blue-600 text-white font-bold">2</span>
                        <span>A new Chrome browser window will open to LinkedIn.</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <span class="flex-shrink-0 w-6 h-6 text-sm flex items-center justify-center rounded-full bg-blue-600 text-white font-bold">3</span>
                        <span><strong>Log in to your LinkedIn account</strong> in that new window.</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <span class="flex-shrink-0 w-6 h-6 text-sm flex items-center justify-center rounded-full bg-blue-600 text-white font-bold">4</span>
                        <span>Once logged in, return here and click "Confirm Login".</span>
                    </li>
                </ol>
                <div class="mt-8 text-center">
                    <button id="startSetupBtn" class="btn-temporal inline-flex justify-center py-3 px-8 border border-transparent shadow-sm text-base font-medium text-white">
                        Start Setup
                    </button>
                </div>
            </div>

            <!-- Step 2: Confirmation -->
            <div id="step2" class="hidden">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Step 2: Confirm Login</h3>
                <p class="text-gray-600 mb-6">The browser window is open. Once you have successfully logged into LinkedIn, please confirm below.</p>
                <div class="p-4 rounded-lg bg-blue-50 border border-blue-200 text-blue-900 text-sm" style="border-radius: 0.25rem;">
                    <strong>Important:</strong> Keep the new browser window open. We need it to detect your profile.
                </div>
                <div class="mt-8 text-center">
                    <button id="confirmLoginBtn" class="inline-flex items-center gap-2 px-8 py-3 text-base font-medium text-white bg-green-600 hover:bg-green-700 transition-colors shadow-lg" style="border-radius: 0.25rem;">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.052-.143Z" clip-rule="evenodd" /></svg>
                        I Have Logged In
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading" class="hidden text-center py-8">
                <div class="flex justify-center items-center mb-4">
                    <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <p class="text-lg text-gray-900" id="loading-message">Detecting and verifying your profile...</p>
                <p class="text-sm text-gray-500">This may take a moment.</p>
            </div>

            <!-- Result State -->
            <div id="result" class="hidden text-center py-8">
                <div id="result-icon" class="mb-4"></div>
                <h3 id="result-message" class="text-2xl font-bold"></h3>
                <p id="result-details" class="mt-2 text-gray-600"></p>
                <div class="mt-8">
                    <a href="{{ url_for('profile') }}" class="inline-flex items-center gap-2 px-6 py-2 text-sm font-medium rounded-md text-gray-900 bg-gray-200 hover:bg-gray-300 transition-colors shadow-md" style="border-radius: 0.25rem;">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M17 10a.75.75 0 0 1-.75.75H5.612l4.158 3.96a.75.75 0 1 1-1.04 1.08l-5.5-5.25a.75.75 0 0 1 0-1.08l5.5-5.25a.75.75 0 1 1 1.04 1.08L5.612 9.25H16.25A.75.75 0 0 1 17 10Z" clip-rule="evenodd" /></svg>
                        Back to Profile
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('startSetupBtn');
    const confirmBtn = document.getElementById('confirmLoginBtn');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const loadingDiv = document.getElementById('loading');
    const resultDiv = document.getElementById('result');

    startBtn.addEventListener('click', function() {
        // Call the backend to launch the browser
        fetch("{{ url_for('setup_assisted_apply_start_browser') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                step1.classList.add('hidden');
                step2.classList.remove('hidden');
            } else {
                alert('Failed to launch browser: ' + data.message);
            }
        })
        .catch(error => alert('Error launching browser: ' + error));
    });

    confirmBtn.addEventListener('click', function() {
        step2.classList.add('hidden');
        loadingDiv.classList.remove('hidden');

        fetch("{{ url_for('setup_assisted_apply_detect') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            loadingDiv.classList.add('hidden');
            resultDiv.classList.remove('hidden');
            const resultIcon = document.getElementById('result-icon');
            const resultMessage = document.getElementById('result-message');
            const resultDetails = document.getElementById('result-details');

            if (data.status === 'success') {
                resultIcon.innerHTML = '<svg class="mx-auto h-16 w-16 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" /></svg>';
                resultMessage.textContent = 'Setup Successful!';
                resultMessage.classList.add('text-green-600');
                resultDetails.textContent = data.message;
            } else {
                resultIcon.innerHTML = '<svg class="mx-auto h-16 w-16 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM8.28 7.22a.75.75 0 0 0-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 1 0 1.06 1.06L10 11.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L11.06 10l1.72-1.72a.75.75 0 0 0-1.06-1.06L10 8.94 8.28 7.22Z" clip-rule="evenodd" /></svg>';
                resultMessage.textContent = 'Setup Failed';
                resultMessage.classList.add('text-red-600');
                resultDetails.textContent = data.message;
            }
        })
        .catch(error => {
            loadingDiv.classList.add('hidden');
            resultDiv.classList.remove('hidden');
            document.getElementById('result-icon').innerHTML = '<svg class="mx-auto h-16 w-16 text-amber-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-8-5a.75.75 0 0 1 .75.75v4.5a.75.75 0 0 1-1.5 0v-4.5A.75.75 0 0 1 10 5Zm0 10a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd" /></svg>';
            document.getElementById('result-message').textContent = 'An Error Occurred';
            document.getElementById('result-message').classList.add('text-amber-600');
            document.getElementById('result-details').textContent = 'Could not communicate with the server. Please check the console and try again.';
            console.error('Error:', error);
        });
    });
});
</script>
{% endblock %}
