{% extends "base.html" %}

{% block title %}Setup Assisted Apply{% endblock %}

{% block content %}
<!-- Full-screen fixed background -->
<div class="fixed inset-0 bg-cover bg-center -z-10" style="background-image: url({{ url_for('static', filename='assets/profiletemporalbg.jpg') }});">
    <div class="absolute inset-0 bg-gray-900/80 backdrop-blur-[4px]"></div>
</div>

<div class="relative max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <div class="text-center mb-10">
        <h1 class="text-4xl font-bold text-transparent bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text">Assisted Apply Setup</h1>
        <p class="mt-2 text-lg text-gray-300">Connect your browser for seamless applications.</p>
    </div>

    <div class="bg-gray-900/40 border border-indigo-500/20 shadow-inner shadow-black/20 backdrop-blur-md rounded-xl overflow-hidden">
        <div class="p-8">
            <!-- Step 1: Instructions -->
            <div id="step1">
                <h3 class="text-xl font-semibold text-gray-100 mb-4">Step 1: Prepare Your Browser</h3>
                <p class="text-gray-400 mb-6">This wizard will launch a new browser window. Please log in to LinkedIn to securely connect your session.</p>
                <ol class="space-y-3 text-gray-300">
                    <li class="flex items-start gap-3"><span class="flex-shrink-0 w-6 h-6 text-sm flex items-center justify-center rounded-full bg-indigo-600 text-white font-bold">1</span><span>Click the "Start Setup" button below.</span></li>
                    <li class="flex items-start gap-3"><span class="flex-shrink-0 w-6 h-6 text-sm flex items-center justify-center rounded-full bg-indigo-600 text-white font-bold">2</span><span>A new Chrome browser window will open to LinkedIn.</span></li>
                    <li class="flex items-start gap-3"><span class="flex-shrink-0 w-6 h-6 text-sm flex items-center justify-center rounded-full bg-indigo-600 text-white font-bold">3</span><span><strong>Log in to your LinkedIn account</strong> in that new window.</span></li>
                    <li class="flex items-start gap-3"><span class="flex-shrink-0 w-6 h-6 text-sm flex items-center justify-center rounded-full bg-indigo-600 text-white font-bold">4</span><span>Once logged in, return here and click "Confirm Login".</span></li>
                </ol>
                <div class="mt-8 text-center">
                    <button id="startSetupBtn" class="btn-temporal inline-flex justify-center py-3 px-8 border border-transparent shadow-sm text-base font-medium rounded-md text-white">
                        Start Setup
                    </button>
                </div>
            </div>

            <!-- Step 2: Confirmation -->
            <div id="step2" class="hidden">
                <h3 class="text-xl font-semibold text-gray-100 mb-4">Step 2: Confirm Login</h3>
                <p class="text-gray-400 mb-6">The browser window is open. Once you have successfully logged into LinkedIn, please confirm below.</p>
                <div class="p-4 rounded-lg bg-cyan-900/50 border border-cyan-500/30 text-cyan-200 text-sm">
                    <strong>Important:</strong> Keep the new browser window open. We need it to detect your profile.
                </div>
                <div class="mt-8 text-center">
                    <button id="confirmLoginBtn" class="inline-flex items-center gap-2 px-8 py-3 text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 transition-colors shadow-lg">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.052-.143Z" clip-rule="evenodd" /></svg>
                        I Have Logged In
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading" class="hidden text-center py-8">
                <div class="flex justify-center items-center mb-4">
                    <svg class="animate-spin h-10 w-10 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <p class="text-lg text-gray-300" id="loading-message">Detecting and verifying your profile...</p>
                <p class="text-sm text-gray-500">This may take a moment.</p>
            </div>

            <!-- Result State -->
            <div id="result" class="hidden text-center py-8">
                <div id="result-icon" class="mb-4"></div>
                <h3 id="result-message" class="text-2xl font-bold"></h3>
                <p id="result-details" class="mt-2 text-gray-400"></p>
                <div class="mt-8">
                    <a href="{{ url_for('profile') }}" class="inline-flex items-center gap-2 px-6 py-2 text-sm font-medium rounded-md text-gray-200 bg-gray-700 hover:bg-gray-600 transition-colors shadow-md">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M17 10a.75.75 0 0 1-.75.75H5.612l4.158 3.96a.75.T75 0 1 1-1.04 1.08l-5.5-5.25a.75.75 0 0 1 0-1.08l5.5-5.25a.75.75 0 1 1 1.04 1.08L5.612 9.25H16.25A.75.75 0 0 1 17 10Z" clip-rule="evenodd" /></svg>
                        Back to Profile
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('startSetupBtn');
    const confirmBtn = document.getElementById('confirmLoginBtn');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const loadingDiv = document.getElementById('loading');
    const resultDiv = document.getElementById('result');

    startBtn.addEventListener('click', function() {
        // Call the backend to launch the browser
        fetch("{{ url_for('setup_assisted_apply_start_browser') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                step1.classList.add('hidden');
                step2.classList.remove('hidden');
            } else {
                alert('Failed to launch browser: ' + data.message);
            }
        })
        .catch(error => alert('Error launching browser: ' + error));
    });

    confirmBtn.addEventListener('click', function() {
        step2.classList.add('hidden');
        loadingDiv.classList.remove('hidden');

        fetch("{{ url_for('setup_assisted_apply_detect') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            loadingDiv.classList.add('hidden');
            resultDiv.classList.remove('hidden');
            const resultIcon = document.getElementById('result-icon');
            const resultMessage = document.getElementById('result-message');
            const resultDetails = document.getElementById('result-details');

            if (data.status === 'success') {
                resultIcon.innerHTML = '<svg class="mx-auto h-16 w-16 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" /></svg>';
                resultMessage.textContent = 'Setup Successful!';
                resultMessage.classList.add('text-green-400');
                resultDetails.textContent = data.message;
            } else {
                resultIcon.innerHTML = '<svg class="mx-auto h-16 w-16 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM8.28 7.22a.75.75 0 0 0-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 1 0 1.06 1.06L10 11.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L11.06 10l1.72-1.72a.75.75 0 0 0-1.06-1.06L10 8.94 8.28 7.22Z" clip-rule="evenodd" /></svg>';
                resultMessage.textContent = 'Setup Failed';
                resultMessage.classList.add('text-red-400');
                resultDetails.textContent = data.message;
            }
        })
        .catch(error => {
            loadingDiv.classList.add('hidden');
            resultDiv.classList.remove('hidden');
            document.getElementById('result-icon').innerHTML = '<svg class="mx-auto h-16 w-16 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-8-5a.75.75 0 0 1 .75.75v4.5a.75.75 0 0 1-1.5 0v-4.5A.75.75 0 0 1 10 5Zm0 10a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd" /></svg>';
            document.getElementById('result-message').textContent = 'An Error Occurred';
            document.getElementById('result-message').classList.add('text-yellow-400');
            document.getElementById('result-details').textContent = 'Could not communicate with the server. Please check the console and try again.';
            console.error('Error:', error);
        });
    });
});
</script>
{% endblock %}
