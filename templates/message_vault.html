{% extends "base.html" %}
{% block content %}
<!-- Full-screen fixed background -->
<div class="fixed inset-0 bg-cover bg-center -z-10" style="background-image: url({{ url_for('static', filename='assets/temporalbg.jpg') }});">
    <div class="absolute inset-0 bg-gray-900/80 backdrop-blur-[4px]"></div>
</div>
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
        <div>
            <h1 class="text-4xl font-bold text-transparent bg-gradient-to-r from-indigo-400 to-pink-400 bg-clip-text">Message Vault</h1>
            <p class="mt-1 text-gray-400">Craft and manage your outreach templates.</p>
        </div>
        <a href="{{ url_for('outreach_studio') }}" class="mt-4 sm:mt-0 inline-flex items-center gap-2 text-sm font-medium text-gray-300 hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M17 10a.75.75 0 0 1-.75.75H5.612l4.158 3.96a.75.75 0 1 1-1.04 1.08l-5.5-5.25a.75.75 0 0 1 0-1.08l5.5-5.25a.75.75 0 1 1 1.04 1.08L5.612 9.25H16.25A.75.75 0 0 1 17 10Z" clip-rule="evenodd" /></svg>
            Back to Outreach Studio
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left Side: Template Editor & Preview -->
        <div class="p-6 bg-gradient-to-b from-gray-800/90 to-gray-900/90 backdrop-blur-lg rounded-xl shadow-xl border border-indigo-500/20 space-y-6">
            <div>
                <h2 id="editor-title" class="text-2xl font-bold text-gray-100">Create New Template</h2>
                <p class="text-sm text-gray-400">Use placeholders like <code class="text-cyan-400">{firstName}</code>, <code class="text-cyan-400">{companyName}</code>, <code class="text-cyan-400">{jobTitle}</code>.</p>
            </div>

            <form id="template-form" class="space-y-4">
                <input type="hidden" id="template-id" name="template_id">
                <div>
                    <label for="template_name" class="block text-sm font-medium text-gray-300">Template Name</label>
                    <input type="text" name="template_name" id="template_name" required class="form-input">
                </div>
                <div>
                    <label for="subject" class="block text-sm font-medium text-gray-300">Subject Line (for emails)</label>
                    <input type="text" name="subject" id="subject" class="form-input">
                </div>
                <div>
                    <label for="body" class="block text-sm font-medium text-gray-300">Message Body</label>
                    <textarea name="body" id="body" rows="8" required class="form-input"></textarea>
                </div>

                <!-- Tone Toggles -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Tone</label>
                    <div class="flex gap-2" id="tone-selector">
                        {% for tone_val, tone_label, tone_emoji in [('direct', 'Direct', 'ðŸŽ¯'), ('warm', 'Warm', 'ðŸ˜Š'), ('playful', 'Playful', 'ðŸŽ‰')] %}
                        <label class="flex-1">
                            <input type="radio" name="tone" value="{{ tone_val }}" class="sr-only" {% if loop.first %}checked{% endif %}>
                            <div class="tone-button cursor-pointer text-center p-3 rounded-lg border-2 border-gray-700 bg-gray-800/50 text-gray-300 transition-all duration-200">
                                <span class="text-xl">{{ tone_emoji }}</span>
                                <span class="block text-xs font-semibold mt-1">{{ tone_label }}</span>
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div class="flex gap-4 pt-2">
                    <button type="submit" id="save-btn" class="btn-temporal flex-1 inline-flex items-center justify-center">Save Template</button>
                    <button type="button" id="clear-btn" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-gray-600 text-sm font-medium rounded-md text-gray-300 bg-gray-800/50 hover:bg-gray-700/50 transition-colors">Clear Form</button>
                </div>
            </form>
        </div>

        <!-- Right Side: Live Preview & Template List -->
        <div class="space-y-8">
            <!-- Live Preview -->
            <div class="p-6 bg-gradient-to-b from-gray-800/90 to-gray-900/90 backdrop-blur-lg rounded-xl shadow-xl border border-cyan-500/20">
                <h2 class="text-2xl font-bold mb-4 text-transparent bg-gradient-to-r from-cyan-400 to-teal-400 bg-clip-text">Live Preview</h2>
                <div class="p-4 bg-gray-900/70 rounded-lg border border-gray-700/50 min-h-[200px]">
                    <div class="flex items-center gap-2 mb-2">
                        <span id="preview-tone-emoji" class="text-xl">ðŸŽ¯</span>
                        <p id="preview-subject" class="font-semibold text-gray-200"></p>
                    </div>
                    <p id="preview-body" class="text-gray-300 whitespace-pre-wrap font-mono text-sm"></p>
                </div>
            </div>

            <!-- Template List -->
            <div class="p-6 bg-gradient-to-b from-gray-800/90 to-gray-900/90 backdrop-blur-lg rounded-xl shadow-xl border border-purple-500/20">
                <h2 class="text-2xl font-bold mb-4 text-transparent bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text">Your Templates</h2>
                <div id="template-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                    {% for template in templates %}
                    <div class="template-item bg-gray-800/60 p-3 rounded-lg flex items-center justify-between shadow-sm border border-gray-700/50 backdrop-blur-sm hover:bg-gray-800/80 transition-colors duration-200" data-template='{{ template | tojson | safe }}'>
                        <div>
                            <h3 class="font-semibold text-gray-100">{{ template.template_name }}</h3>
                            <p class="text-xs text-gray-400">{{ template.subject or 'No Subject' }}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="edit-btn text-indigo-400 hover:text-indigo-300 text-sm font-medium">Edit</button>
                            <button class="delete-btn text-red-400 hover:text-red-300 text-sm font-medium" data-id="{{ template.id }}">Delete</button>
                        </div>
                    </div>
                    {% else %}
                    <p id="no-templates-msg" class="text-sm text-gray-400 text-center py-4">No templates created yet.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-input {
    @apply mt-1 block w-full rounded-md bg-gray-700/50 border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-gray-100 placeholder-gray-400 backdrop-blur-sm;
}
.tone-button.selected {
    @apply border-cyan-400 bg-cyan-900/50 text-white;
    box-shadow: 0 0 10px rgba(34, 211, 238, 0.3);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('template-form');
    const editorTitle = document.getElementById('editor-title');
    const templateIdInput = document.getElementById('template-id');
    const templateNameInput = document.getElementById('template_name');
    const subjectInput = document.getElementById('subject');
    const bodyInput = document.getElementById('body');
    const saveBtn = document.getElementById('save-btn');
    const clearBtn = document.getElementById('clear-btn');
    const templateList = document.getElementById('template-list');
    const noTemplatesMsg = document.getElementById('no-templates-msg');

    // Live Preview Elements
    const previewSubject = document.getElementById('preview-subject');
    const previewBody = document.getElementById('preview-body');
    const previewToneEmoji = document.getElementById('preview-tone-emoji');
    let typingInterval;

    const toneEmojis = { direct: 'ðŸŽ¯', warm: 'ðŸ˜Š', playful: 'ðŸŽ‰' };

    // --- Form & Editor Logic ---
    function clearForm() {
        form.reset();
        templateIdInput.value = '';
        editorTitle.textContent = 'Create New Template';
        saveBtn.textContent = 'Save Template';
        document.querySelector('input[name="tone"][value="direct"]').checked = true;
        updateToneSelection();
        updatePreview();
    }

    clearBtn.addEventListener('click', clearForm);

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const templateId = templateIdInput.value;
        const isUpdating = !!templateId;
        const url = isUpdating ? `/api/templates/${templateId}` : '/api/templates';
        const method = isUpdating ? 'PUT' : 'POST';

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        saveBtn.disabled = true;
        saveBtn.classList.add('button-loading');

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (response.ok) {
                // For simplicity, we just reload the page on success
                window.location.reload();
            } else {
                alert(`Error: ${result.message}`);
            }
        } catch (error) {
            alert('An error occurred. Please try again.');
        } finally {
            saveBtn.disabled = false;
            saveBtn.classList.remove('button-loading');
        }
    });

    // --- Template List Logic ---
    templateList.addEventListener('click', function(e) {
        if (e.target.classList.contains('edit-btn')) {
            const item = e.target.closest('.template-item');
            const template = JSON.parse(item.dataset.template);
            
            editorTitle.textContent = 'Edit Template';
            saveBtn.textContent = 'Update Template';
            templateIdInput.value = template.id;
            templateNameInput.value = template.template_name;
            subjectInput.value = template.subject;
            bodyInput.value = template.body;
            document.querySelector(`input[name="tone"][value="${template.tone || 'direct'}"]`).checked = true;
            
            updateToneSelection();
            updatePreview();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        if (e.target.classList.contains('delete-btn')) {
            const templateId = e.target.dataset.id;
            if (confirm('Are you sure you want to delete this template?')) {
                deleteTemplate(templateId, e.target.closest('.template-item'));
            }
        }
    });

    async function deleteTemplate(templateId, element) {
        try {
            const response = await fetch(`/api/templates/${templateId}`, { method: 'DELETE' });
            if (response.ok) {
                element.remove();
                if (templateList.children.length === 0) {
                    noTemplatesMsg.classList.remove('hidden');
                }
            } else {
                const result = await response.json();
                alert(`Error: ${result.message}`);
            }
        } catch (error) {
            alert('An error occurred while deleting the template.');
        }
    }

    // --- Live Preview & Tone Logic ---
    function updateToneSelection() {
        document.querySelectorAll('.tone-button').forEach(btn => btn.classList.remove('selected'));
        const selectedRadio = document.querySelector('input[name="tone"]:checked');
        if (selectedRadio) {
            selectedRadio.closest('.tone-button').classList.add('selected');
            previewToneEmoji.textContent = toneEmojis[selectedRadio.value];
        }
    }

    document.getElementById('tone-selector').addEventListener('change', () => {
        updateToneSelection();
        updatePreview();
    });

    function updatePreview() {
        clearInterval(typingInterval);
        const subject = subjectInput.value;
        const body = bodyInput.value;
        
        previewSubject.textContent = subject ? `Subject: ${subject}` : '';
        previewBody.textContent = '';

        let i = 0;
        typingInterval = setInterval(() => {
            if (i < body.length) {
                previewBody.textContent += body.charAt(i);
                i++;
            } else {
                clearInterval(typingInterval);
            }
        }, 15); // Typing speed
    }

    [subjectInput, bodyInput].forEach(input => {
        input.addEventListener('input', updatePreview);
    });

    // Initial state setup
    updateToneSelection();
    updatePreview();
});
</script>
{% endblock %}