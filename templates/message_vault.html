{% extends "base.html" %}
{% block body_class %}light-theme{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Message Vault</h1>
            <p class="mt-1 text-gray-600">Craft and manage your outreach templates.</p>
        </div>
        <a href="{{ url_for('outreach_studio') }}" class="mt-4 sm:mt-0 inline-flex items-center gap-2 text-sm font-medium text-gray-600 hover:text-gray-900 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M17 10a.75.75 0 0 1-.75.75H5.612l4.158 3.96a.75.75 0 1 1-1.04 1.08l-5.5-5.25a.75.75 0 0 1 0-1.08l5.5-5.25a.75.75 0 1 1 1.04 1.08L5.612 9.25H16.25A.75.75 0 0 1 17 10Z" clip-rule="evenodd" /></svg>
            Back to Outreach Studio
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left Side: Template Editor & Preview -->
        <div class="p-6 bg-white border border-black rounded-xl shadow-md space-y-6" style="border-radius: 0.25rem; border: 1px solid black;">
            <div>
                <h2 id="editor-title" class="text-2xl font-bold text-gray-900">Create New Template</h2>
                
            </div>

            <form id="template-form" class="space-y-4">
                <input type="hidden" id="template-id" name="template_id">
                <div>
                    <label for="template_name" class="block text-sm font-medium text-gray-700">Template Name</label>
                    <input type="text" name="template_name" id="template_name" required class="form-input" placeholder="e.g., Initial Outreach - Software Engineer">
                </div>
                <div>
                    <label for="subject" class="block text-sm font-medium text-gray-700">Subject Line (for emails)</label>
                    <input type="text" name="subject" id="subject" class="form-input" placeholder="e.g., Question about {jobTitle} role">
                </div>
                <div>
                    <label for="body" class="block text-sm font-medium text-gray-700">Message Body</label>
                    <textarea name="body" id="body" rows="8" required class="form-input" placeholder="Hi {firstName}, I saw you are hiring for..."></textarea>
                </div>

                <div class="flex gap-4 pt-2">
                    <button type="submit" id="save-btn" class="btn-temporal flex-1 inline-flex items-center justify-center py-2 px-4 text-sm font-medium rounded-md shadow-sm text-white">Save Template</button>
                    <button type="button" id="clear-btn" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors" style="border-radius: 0.25rem;">Clear Form</button>
                </div>
            </form>
        </div>

        <!-- Right Side: Live Preview & Template List -->
        <div class="space-y-8">
            <!-- Live Preview -->
            <div class="p-6 bg-white border border-gray-200 rounded-xl shadow-md" style="border-radius: 0.25rem;">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Live Preview</h2>
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[200px]" style="border-radius: 0.25rem;">
                    <div class="flex items-center gap-2 mb-2">
                        <p id="preview-subject" class="font-semibold text-gray-900"></p>
                    </div>
                    <p id="preview-body" class="text-gray-600 whitespace-pre-wrap font-mono text-sm"></p>
                </div>
            </div>

            <!-- Template List -->
            <div class="p-6 bg-white border border-gray-200 rounded-xl shadow-md" style="border-radius: 0.25rem;">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Your Templates</h2>
                <div id="template-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                    {% for template in templates %}
                    <div class="template-item bg-white p-3 rounded-lg flex items-center justify-between shadow-sm border border-gray-200 hover:shadow-md transition-all duration-200" data-template='{{ template | tojson | safe }}' style="border-radius: 0.25rem;">
                        <div>
                            <h3 class="font-semibold text-gray-900">{{ template.template_name }}</h3>
                            <p class="text-xs text-gray-500">{{ template.subject or 'No Subject' }}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="edit-btn text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</button>
                            <button class="delete-btn text-red-600 hover:text-red-800 text-sm font-medium" data-id="{{ template.id }}">Delete</button>
                        </div>
                    </div>
                    {% else %}
                    <p id="no-templates-msg" class="text-sm text-gray-500 text-center py-4">No templates created yet.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-input {
    @apply mt-1 block w-full rounded-md bg-white shadow-sm focus:border-blue-500 focus:ring-blue-500 text-gray-900 placeholder-gray-500;
    border: 1px solid black !important;
    border-radius: 0.25rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('template-form');
    const editorTitle = document.getElementById('editor-title');
    const templateIdInput = document.getElementById('template-id');
    const templateNameInput = document.getElementById('template_name');
    const subjectInput = document.getElementById('subject');
    const bodyInput = document.getElementById('body');
    const saveBtn = document.getElementById('save-btn');
    const clearBtn = document.getElementById('clear-btn');
    const templateList = document.getElementById('template-list');
    const noTemplatesMsg = document.getElementById('no-templates-msg');

    // Live Preview Elements
    const previewSubject = document.getElementById('preview-subject');
    const previewBody = document.getElementById('preview-body');
    let typingInterval;

    // --- Form & Editor Logic ---
    function clearForm() {
        form.reset();
        templateIdInput.value = '';
        editorTitle.textContent = 'Create New Template';
        saveBtn.textContent = 'Save Template';
        updatePreview();
    }

    clearBtn.addEventListener('click', clearForm);

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const templateId = templateIdInput.value;
        const isUpdating = !!templateId;
        const url = isUpdating ? `/api/templates/${templateId}` : '/api/templates';
        const method = isUpdating ? 'PUT' : 'POST';

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        saveBtn.disabled = true;
        saveBtn.classList.add('button-loading');

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (response.ok) {
                // For simplicity, we just reload the page on success
                window.location.reload();
            } else {
                alert(`Error: ${result.message}`);
            }
        } catch (error) {
            alert('An error occurred. Please try again.');
        } finally {
            saveBtn.disabled = false;
            saveBtn.classList.remove('button-loading');
        }
    });

    // --- Template List Logic ---
    templateList.addEventListener('click', function(e) {
        if (e.target.classList.contains('edit-btn')) {
            const item = e.target.closest('.template-item');
            const template = JSON.parse(item.dataset.template);
            
            editorTitle.textContent = 'Edit Template';
            saveBtn.textContent = 'Update Template';
            templateIdInput.value = template.id;
            templateNameInput.value = template.template_name;
            subjectInput.value = template.subject;
            bodyInput.value = template.body;
            
            updatePreview();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        if (e.target.classList.contains('delete-btn')) {
            const templateId = e.target.dataset.id;
            if (confirm('Are you sure you want to delete this template?')) {
                deleteTemplate(templateId, e.target.closest('.template-item'));
            }
        }
    });

    async function deleteTemplate(templateId, element) {
        try {
            const response = await fetch(`/api/templates/${templateId}`, { method: 'DELETE' });
            if (response.ok) {
                element.remove();
                if (templateList.children.length === 0) {
                    noTemplatesMsg.classList.remove('hidden');
                }
            } else {
                const result = await response.json();
                alert(`Error: ${result.message}`);
            }
        } catch (error) {
            alert('An error occurred while deleting the template.');
        }
    }

    function updatePreview() {
        clearInterval(typingInterval);
        const subject = subjectInput.value;
        const body = bodyInput.value;
        
        previewSubject.textContent = subject ? `Subject: ${subject}` : '';
        previewBody.textContent = '';

        let i = 0;
        typingInterval = setInterval(() => {
            if (i < body.length) {
                previewBody.textContent += body.charAt(i);
                i++;
            } else {
                clearInterval(typingInterval);
            }
        }, 15); // Typing speed
    }

    [subjectInput, bodyInput].forEach(input => {
        input.addEventListener('input', updatePreview);
    });

    // Initial state setup
    updatePreview();
});
</script>
{% endblock %}